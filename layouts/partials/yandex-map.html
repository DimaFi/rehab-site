<!-- Яндекс карта -->
<div class="map-section">
    <div class="container">
        <h2 class="section-title">Как нас найти</h2>
        <div class="map-container">
            <div class="yandex-map" data-map-id="map-{{ now.Unix }}-{{ substr (md5 (printf "%s" .)) 0 6 }}"></div>
        </div>
        <div class="map-address">
            <p><strong>Адрес:</strong> {{ .Site.Params.address }}</p>
        </div>
    </div>
</div>

<script>
    // Инициализация Яндекс карты с точными координатами
    (function() {
        // Точные координаты: Ижевск, ул. Азина, 150
        const center = [56.817567, 53.177166]; // Широта, долгота
        const address = '{{ .Site.Params.address }}';
        
        function initYandexMaps() {
            const mapContainers = document.querySelectorAll('.yandex-map:not([data-initialized])');
            
            if (mapContainers.length === 0) return;
            
            if (typeof ymaps !== 'undefined') {
                ymaps.ready(function () {
                    mapContainers.forEach(function(container, index) {
                        const uniqueMapId = container.getAttribute('data-map-id') || 'map-' + Date.now() + '-' + index;
                        container.id = uniqueMapId;
                        container.setAttribute('data-initialized', 'true');
                        
                        const map = new ymaps.Map(uniqueMapId, {
                            center: center,
                            zoom: 16,
                            controls: ['zoomControl', 'fullscreenControl']
                        });

                        // Создание метки с точными координатами
                        const placemark = new ymaps.Placemark(center, {
                            balloonContent: address,
                            iconCaption: 'Медицинский центр'
                        }, {
                            preset: 'islands#blueMedicalIcon'
                        });

                        map.geoObjects.add(placemark);
                        
                        // Открытие балуна при клике на метку
                        placemark.events.add('click', function () {
                            placemark.balloon.open();
                        });
                    });
                });
            }
        }
        
        // Загрузка карты после загрузки страницы и API
        if (typeof ymaps !== 'undefined') {
            initYandexMaps();
        } else {
            function checkAndInit() {
                if (typeof ymaps !== 'undefined') {
                    ymaps.ready(initYandexMaps);
                } else {
                    setTimeout(checkAndInit, 100);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkAndInit);
            } else {
                checkAndInit();
            }
        }
    })();
</script>
