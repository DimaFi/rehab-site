name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  HUGO_VERSION: "0.148.2"
  NODE_VERSION: "20"
  # Берём из secrets, но если не задан — будет дефолт
  DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}

jobs:
  build-and-deploy:
    name: Build Hugo site and deploy to VDS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build CSS (optional)
        run: |
          npm run build 2>/dev/null || echo "No build script found, skipping CSS build"
        continue-on-error: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: Build Hugo site
        run: |
          hugo --minify --gc

      - name: Verify build output
        run: |
          test -f public/index.html
          echo "Build successful! Top files in public/:"
          ls -lah public/ | head -20

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VDS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Verify SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 \
            ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }} "echo 'SSH connection successful'"

      - name: Deploy public/ to VDS via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
            ./public/ \
            ${{ secrets.VDS_USER }}@${{ secrets.VDS_HOST }}:${{ secrets.VDS_PATH }}/

          echo "Deployment completed successfully!"

      # ⚠️ УБРАЛ шаг с sudo chown/chmod: в Actions он часто падает без NOPASSWD.
      # Права лучше настроить один раз на VPS вручную.

      - name: Verify deployment (HTTPS -> HTTP fallback)
        continue-on-error: true
        run: |
          DOMAIN="${DOMAIN_NAME:-narcologia-24.ru}"
          HTTPS_URL="https://${DOMAIN}"
          HTTP_URL="http://${DOMAIN}"

          echo "Waiting for deployment to be available..."
          sleep 5

          CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 --location "$HTTPS_URL" || echo "000")
          if [ "$CODE" = "000" ]; then
            echo "HTTPS not ready, trying HTTP..."
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 --location "$HTTP_URL" || echo "000")
          fi

          echo "Verification HTTP code: $CODE"



      - name: Cleanup SSH keys
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
          echo "SSH keys cleaned up"
